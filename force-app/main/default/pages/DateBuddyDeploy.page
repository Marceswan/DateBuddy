<apex:page controller="DateStampTriggerDeployer" showHeader="false" sidebar="false" standardStylesheets="false">
    <apex:includeScript value="{!$Resource.jsziplib}"/>
    
    <script>
        // Global variable to store deployment result
        window.deploymentResult = null;
        
        function createFullDeploymentZip(objectApiName, packageData) {
            try {
                var zip = new JSZip();
                
                // Add package.xml from server
                zip.file("package.xml", packageData.packageXml);
                
                // Add trigger files
                zip.folder("triggers").file(packageData.triggerName + ".trigger", packageData.triggerSource);
                zip.folder("triggers").file(packageData.triggerName + ".trigger-meta.xml", packageData.triggerMetadata);
                
                // Add test class files
                zip.folder("classes").file(packageData.testClassName + ".cls", packageData.testClassSource);
                zip.folder("classes").file(packageData.testClassName + ".cls-meta.xml", packageData.testClassMetadata);
                
                // Generate base64 ZIP
                return zip.generateAsync({type: "base64"})
                    .then(function(base64) {
                        return deployTriggerZip(base64, packageData.testClassName, packageData.triggerName);
                    });
            } catch(e) {
                console.error('Error creating ZIP:', e);
                window.deploymentResult = {
                    success: false,
                    error: e.message || 'Failed to create ZIP file'
                };
                return Promise.reject(e);
            }
        }
        
        function deployTriggerZip(base64Zip, testClassName, triggerName) {
            return new Promise(function(resolve, reject) {
                Visualforce.remoting.Manager.invokeAction(
                    '{!$RemoteAction.DateStampTriggerDeployer.deployZip}',
                    base64Zip,
                    testClassName,
                    triggerName,
                    function(result, event) {
                        if (event.status) {
                            window.deploymentResult = {
                                success: true,
                                asyncResultId: result,
                                deploymentId: result
                            };
                            resolve(result);
                        } else {
                            window.deploymentResult = {
                                success: false,
                                error: event.message || 'Deployment failed'
                            };
                            reject(new Error(event.message));
                        }
                    },
                    {escape: false, timeout: 120000}
                );
            });
        }
        
        // Function to be called from LWC or external context
        window.deployTrigger = function(objectApiName) {
            return new Promise(function(resolve, reject) {
                // Get complete deployment package including test class
                Visualforce.remoting.Manager.invokeAction(
                    '{!$RemoteAction.DateStampTriggerDeployer.prepareDeploymentPackage}',
                    objectApiName,
                    function(result, event) {
                        if (event.status && result) {
                            createFullDeploymentZip(objectApiName, result)
                                .then(function(asyncResultId) {
                                    resolve(asyncResultId);
                                })
                                .catch(function(error) {
                                    reject(error);
                                });
                        } else {
                            window.deploymentResult = {
                                success: false,
                                error: event.message || 'Failed to get deployment package'
                            };
                            reject(new Error(event.message || 'Failed to get deployment package'));
                        }
                    },
                    {escape: false}
                );
            });
        };
        
        // Function to check deployment status
        window.checkDeploymentStatus = function(asyncResultId) {
            return new Promise(function(resolve, reject) {
                Visualforce.remoting.Manager.invokeAction(
                    '{!$RemoteAction.DateStampTriggerDeployer.checkDeploymentStatus}',
                    asyncResultId,
                    function(result, event) {
                        if (event.status) {
                            resolve(result);
                        } else {
                            reject(new Error(event.message || 'Failed to check status'));
                        }
                    },
                    {escape: false}
                );
            });
        };
    </script>
    
    <style>
        body {
            font-family: 'Salesforce Sans', Arial, sans-serif;
            background: #f4f6f9;
            margin: 0;
            padding: 20px;
        }
        #status {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 24px;
            max-width: 800px;
            margin: 0 auto;
        }
        h2 {
            color: #032e61;
            margin-top: 0;
            font-size: 20px;
            font-weight: 300;
        }
        #message {
            color: #16325c;
            margin: 16px 0;
        }
        .progress-container {
            margin: 20px 0;
            background: #ecebea;
            border-radius: 4px;
            height: 8px;
            overflow: hidden;
            position: relative;
        }
        .progress-bar {
            background: #0070d2;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        .status-info {
            display: flex;
            justify-content: space-between;
            margin: 12px 0;
            font-size: 14px;
            color: #54698d;
        }
        .test-results {
            margin-top: 24px;
            border: 1px solid #dddbda;
            border-radius: 4px;
            overflow: hidden;
        }
        .test-results table {
            width: 100%;
            border-collapse: collapse;
        }
        .test-results th {
            background: #f4f6f9;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #032e61;
            border-bottom: 1px solid #dddbda;
        }
        .test-results td {
            padding: 12px;
            border-bottom: 1px solid #ecebea;
        }
        .test-pass {
            color: #04844b;
            font-weight: 600;
        }
        .test-fail {
            color: #c23934;
            font-weight: 600;
        }
        .error-message {
            background: #fef1f1;
            border-left: 4px solid #c23934;
            padding: 12px;
            margin: 16px 0;
            border-radius: 4px;
        }
        .success-message {
            background: #ebf7ed;
            border-left: 4px solid #04844b;
            padding: 12px;
            margin: 16px 0;
            border-radius: 4px;
            color: #032e61;
        }
        .sticky-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #c23934;
            color: white;
            padding: 16px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            max-width: 400px;
            display: none;
        }
        .sticky-toast.show {
            display: block;
            animation: slideIn 0.3s ease;
        }
        .sticky-toast .close-btn {
            float: right;
            cursor: pointer;
            margin-left: 12px;
            font-size: 20px;
            line-height: 1;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .close-message {
            background: #f4f6f9;
            padding: 12px;
            border-radius: 4px;
            margin-top: 16px;
            text-align: center;
            color: #54698d;
        }
    </style>
    
    <div id="status">
        <h2>DateBuddy Trigger Deployment</h2>
        <div id="message">Initializing...</div>
        <div id="progressContainer" style="display: none;">
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="status-info">
                <span id="deployStatus">Starting deployment...</span>
                <span id="componentProgress">0 / 0 components</span>
            </div>
        </div>
        <div id="testResultsContainer" style="display: none;">
            <div class="test-results">
                <table>
                    <thead>
                        <tr>
                            <th>Test Class</th>
                            <th>Method</th>
                            <th>Status</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody id="testResultsBody">
                    </tbody>
                </table>
            </div>
        </div>
        <div id="errorContainer" style="display: none;">
        </div>
    </div>
    
    <div class="sticky-toast" id="validationToast">
        <span class="close-btn" onclick="closeToast()">Ã—</span>
        <strong>Validation Rule Conflict Detected</strong><br/>
        Please disable the validation rule and try again.
    </div>
    
    <script>
        var pollingInterval;
        var deploymentStartTime;
        
        function closeToast() {
            document.getElementById('validationToast').classList.remove('show');
        }
        
        function updateProgressBar(deployed, total) {
            var percentage = total > 0 ? (deployed / total) * 100 : 0;
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('componentProgress').textContent = deployed + ' / ' + total + ' components';
        }
        
        function displayTestResults(testResults) {
            if (!testResults || testResults.length === 0) return;
            
            document.getElementById('testResultsContainer').style.display = 'block';
            var tbody = document.getElementById('testResultsBody');
            tbody.innerHTML = '';
            
            testResults.forEach(function(test) {
                var row = tbody.insertRow();
                row.insertCell(0).textContent = test.className || test.name || 'Unknown';
                row.insertCell(1).textContent = test.methodName || 'Unknown';
                
                var statusCell = row.insertCell(2);
                var outcome = test.outcome || (test.success ? 'Pass' : 'Fail');
                statusCell.textContent = outcome;
                statusCell.className = outcome === 'Pass' ? 'test-pass' : 'test-fail';
                
                row.insertCell(3).textContent = test.message || '';
                
                // Check for validation rule conflicts
                if (test.message && test.message.indexOf('FIELD_CUSTOM_VALIDATION_EXCEPTION') !== -1) {
                    document.getElementById('validationToast').classList.add('show');
                }
            });
        }
        
        function displayErrors(errors) {
            if (!errors || errors.length === 0) return;
            
            var errorContainer = document.getElementById('errorContainer');
            errorContainer.style.display = 'block';
            errorContainer.innerHTML = '';
            
            errors.forEach(function(error) {
                var errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                var errorText = '';
                if (typeof error === 'object') {
                    errorText = (error.fileName || '') + ': ' + (error.problem || error.message || JSON.stringify(error));
                } else {
                    errorText = error;
                }
                errorDiv.textContent = errorText;
                errorContainer.appendChild(errorDiv);
            });
        }
        
        function pollDeploymentStatus(asyncResultId) {
            document.getElementById('progressContainer').style.display = 'block';
            deploymentStartTime = Date.now();
            
            pollingInterval = setInterval(function() {
                window.checkDeploymentStatus(asyncResultId)
                    .then(function(result) {
                        // Update progress
                        updateProgressBar(result.numberComponentsDeployed || 0, result.numberComponentsTotal || 0);
                        document.getElementById('deployStatus').textContent = 
                            'Status: ' + (result.status || 'Processing');
                        
                        // Notify parent window (LWC) of status update
                        if (window.parent && window.parent !== window) {
                            window.parent.postMessage({
                                type: 'deploymentStatus',
                                deploymentId: asyncResultId,
                                status: result
                            }, '*');
                        }
                        
                        // Check if deployment is done
                        if (result.done) {
                            clearInterval(pollingInterval);
                            
                            // Display test results
                            if (result.testFailures && result.testFailures.length > 0) {
                                displayTestResults(result.testFailures);
                            }
                            
                            // Display component errors
                            if (result.componentFailures && result.componentFailures.length > 0) {
                                displayErrors(result.componentFailures);
                            }
                            
                            // Send final notification to parent
                            if (window.parent && window.parent !== window) {
                                window.parent.postMessage({
                                    type: 'deploymentComplete',
                                    deploymentId: asyncResultId,
                                    status: result
                                }, '*');
                            }
                            
                            // Handle completion
                            if (result.status === 'Succeeded') {
                                var successDiv = document.createElement('div');
                                successDiv.className = 'success-message';
                                successDiv.innerHTML = '<strong>âœ“ Deployment Successful!</strong><br/>All components deployed successfully.';
                                document.getElementById('message').appendChild(successDiv);
                                
                                // Show auto-close notice
                                var closeNotice = document.createElement('div');
                                closeNotice.className = 'close-message';
                                closeNotice.innerHTML = 'This window will close automatically in a moment...';
                                document.getElementById('message').appendChild(closeNotice);
                                
                                // Auto-close after 2 seconds only on success
                                setTimeout(function() {
                                    window.close();
                                }, 2000);
                            } else if (result.status === 'Failed' || result.status === 'Canceled') {
                                // For failed or canceled deployments, show message but don't auto-close
                                var closeDiv = document.createElement('div');
                                closeDiv.className = 'close-message';
                                closeDiv.innerHTML = 'Deployment ' + result.status.toLowerCase() + '. You can close this window when you are ready.';
                                document.getElementById('message').appendChild(closeDiv);
                                
                                // Set error result for parent window
                                window.deploymentResult = {
                                    success: false,
                                    error: 'Deployment ' + result.status
                                };
                            }
                        }
                    })
                    .catch(function(error) {
                        // Error checking status, retry
                        console.error('Error checking status:', error);
                    });
            }, 2000); // Poll every 2 seconds
        }
        
        // Auto-deploy if objectApiName is provided in URL
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const objectApiName = urlParams.get('objectApiName');
            
            if (objectApiName) {
                document.getElementById('message').innerHTML = '<strong>Deploying trigger for:</strong> ' + objectApiName;
                
                window.deployTrigger(objectApiName)
                    .then(function(asyncResultId) {
                        document.getElementById('message').innerHTML = 
                            '<strong>Deployment initiated</strong><br/>Tracking deployment progress...';
                        
                        // Start polling for status
                        pollDeploymentStatus(asyncResultId);
                        
                        // Set result for parent window
                        window.deploymentResult = {
                            success: true,
                            asyncResultId: asyncResultId
                        };
                    })
                    .catch(function(error) {
                        document.getElementById('message').innerHTML = '';
                        var errorDiv = document.createElement('div');
                        errorDiv.className = 'error-message';
                        errorDiv.innerHTML = '<strong>Deployment failed:</strong> ' + error.message;
                        document.getElementById('message').appendChild(errorDiv);
                        
                        // Set error result for parent window
                        window.deploymentResult = {
                            success: false,
                            error: error.message
                        };
                    });
            } else {
                document.getElementById('message').innerHTML = 
                    'No object specified. Add ?objectApiName=YourObject to the URL.';
            }
        };
    </script>
</apex:page>